<!DOCTYPE html>
<html>
<head>
    <title>SSE Test</title>
    <style>
        .log-container {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            background-color: #f5f5f5;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .log-entry.received { background-color: #e6ffe6; }
        .log-entry.error { background-color: #ffe6e6; }
        .log-entry.info { background-color: #e6e6ff; }
        .controls {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
        }
        input, button {
            margin: 5px;
            padding: 5px;
        }
        .status {
            margin-top: 10px;
            padding: 5px;
            border-radius: 3px;
        }
        .status.connected { background-color: #90EE90; }
        .status.disconnected { background-color: #FFB6C1; }
    </style>
</head>
<body>
    <div class="controls">
        <div>
            <input type="text" id="tickers" placeholder="Tickers (e.g., AAPL,GOOGL)" value="AAPL">
            <input type="number" id="window" placeholder="Window" value="1" min="1">
            <input type="number" id="limit" placeholder="Limit" value="2" min="1">
        </div>
        <div style="margin-top: 10px;">
            <button onclick="startStream()">Start Stream</button>
            <button onclick="stopStream()">Stop Stream</button>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>
        <div id="connectionStatus" class="status disconnected">
            Status: Disconnected
        </div>
    </div>
    <div id="logs" class="log-container"></div>

    <script>
        let eventSource = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 3;

        function updateConnectionStatus(connected, message = '') {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
            statusDiv.textContent = `Status: ${connected ? 'Connected' : 'Disconnected'} ${message}`;
        }

        function addLogEntry(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `${new Date().toISOString()} - ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            addLogEntry('Logs cleared');
        }

        function stopStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                addLogEntry('Stream manually stopped', 'info');
                updateConnectionStatus(false);
            }
        }

        function startStream() {
            stopStream();
            reconnectAttempts = 0;

            const tickers = document.getElementById('tickers').value;
            const window = document.getElementById('window').value;
            const limit = document.getElementById('limit').value;

            if (!tickers) {
                addLogEntry('Please enter at least one ticker', 'error');
                return;
            }

            const params = new URLSearchParams({
                tickers,
                window,
                limit
            });

            const apiUrl = `http://localhost:8000/api/generate?${params.toString()}`;
            addLogEntry(`Connecting to: ${apiUrl}`);

            try {
                // Monitor the request
                const controller = new AbortController();
                const signal = controller.signal;
                
                // First, check if the endpoint is accessible
                fetch(apiUrl, { signal })
                    .then(response => {
                        addLogEntry(`Server responded with status: ${response.status}`, 'info');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    })
                    .catch(error => {
                        addLogEntry(`Fetch error: ${error.message}`, 'error');
                    });

                // Then create EventSource
                eventSource = new EventSource(apiUrl);
                
                eventSource.onopen = (event) => {
                    addLogEntry('Connection established successfully', 'info');
                    updateConnectionStatus(true);
                    reconnectAttempts = 0;
                };

                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        addLogEntry(`Received: ${JSON.stringify(data, null, 2)}`, 'received');
                    } catch (error) {
                        addLogEntry(`Error parsing message: ${error.message}`, 'error');
                    }
                };

                eventSource.onerror = (error) => {
                    const errorDetails = {
                        readyState: eventSource.readyState,
                        status: error.status,
                        statusText: error.statusText,
                        message: error.message || 'Unknown error'
                    };
                    
                    addLogEntry(`Connection error details: ${JSON.stringify(errorDetails, null, 2)}`, 'error');
                    
                    if (eventSource.readyState === EventSource.CLOSED) {
                        updateConnectionStatus(false, '(Closed)');
                        addLogEntry('Connection closed by server', 'error');
                        
                        // Attempt to reconnect
                        if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                            reconnectAttempts++;
                            addLogEntry(`Attempting to reconnect (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`, 'info');
                            setTimeout(startStream, 2000);
                        } else {
                            addLogEntry('Max reconnection attempts reached', 'error');
                        }
                    }
                };

            } catch (error) {
                addLogEntry(`Failed to create EventSource: ${error.message}`, 'error');
                updateConnectionStatus(false, '(Error)');
            }
        }
    </script>
</body>
</html>